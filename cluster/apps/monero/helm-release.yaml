---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: &app monerod
  namespace: monero
spec:
  interval: 15m
  chart:
    spec:
      chart: app-template
      version: 0.2.2
      sourceRef:
        kind: HelmRepository
        name: bjw-s-charts
        namespace: flux-system
      interval: 15m
  install:
    createNamespace: true
    remediation:
      retries: 5
  upgrade:
    remediation:
      retries: 5
  values:
    initContainers:
      init-permissions:
        image: busybox:1.35.0
        imagePullPolicy: IfNotPresent
        command:
          - sh
          - c
        args:
          - chown -R 1000:1000 /home/monero
        securityContext:
          runAsUser: 0
        volumeMounts:
          - name: bitmonero-pvc
            mountPath: /home/monero/
    global:
      nameOverride: *app
    image:
      repository: sethsimmons/simple-monerod
      tag: v0.18.1.1
    environment:
      user: 1000:1000
    args:
      - --rpc-restricted-bind-ip=0.0.0.0
      - --rpc-restricted-bind-port=18089
      - --public-node
      - --no-igd
      - --zmq-pub=tcp://0.0.0.0:18083
      - --enable-dns-blocklist
      - --prune-blockchain
      - --in-peers=50
      - --out-peers=50
    additionalContainers:
      - name: tor
        image: goldy/tor-hidden-service
        tag: v0.4.7.8-57f8867
        env:
          - name: MONEROD_TOR_SERVICE_HOSTS
            value: 18089:monerod:18089
          - name: MONEROD_TOR_SERVICE_VERSION
            value: 3
        nodeSelector:
          node-role.kubernetes.io/worker: "true"
        persistence:
          tor-keys:
            enabled: true
            mountPath: /var/lib/tor/hidden_service/
            existingClaim: tor-keys-pvc
    service:
      main:
        ports:
          http:
            enabled: false
          p2p:
            enabled: true
            port: 18080
            targetPort: 18080
            protocol: TCP
          zmq:
            enabled: true
            port: 18083
            targetPort: 18083
            protocol: TCP
          rpc-restricted:
            enabled: true
            port: 18089
            targetPort: 18089
            protocol: TCP
    nodeSelector:
      node-role.kubernetes.io/worker: "true"
    persistence:
      bitmonero:
        enabled: true
        mountPath: /home/monero/
        existingClaim: bitmonero-pvc
    resources:
      requests:
        cpu: 200m
        memory: 200Mi
      limits:
        memory: 500Mi
    securityContext:
      readOnlyRootFilesystem: false
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000
